name: Terraform and Docker

on:
  push:
    branches:
      - main
      - dev
      - staging

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  TF_VAR_ENVIRONMENT: ${{ github.ref == 'refs/heads/dev' && 'dev' || github.ref == 'refs/heads/main' && 'prod' || github.ref == 'refs/heads/staging' && 'staging' }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Debug Environment Variables
        run: |
          echo "TF_VAR_ENVIRONMENT: $TF_VAR_ENVIRONMENT"
          echo "AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID"
          echo "AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION"

      - name: Select or Create Terraform Workspace
        run: |
          cd HuggingFace/aws/
          WORKSPACE_NAME=${{ github.ref == 'refs/heads/dev' && 'dev' || github.ref == 'refs/heads/main' && 'prod' || github.ref == 'refs/heads/staging' && 'staging' }}
          echo "Terraform workspace: $WORKSPACE_NAME"
          echo "AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION"
          terraform workspace select $WORKSPACE_NAME || terraform workspace new $WORKSPACE_NAME

      - name: Terraform Init and Plan
        run: |
          cd HuggingFace/aws/
          terraform init && terraform plan

      - name: Terraform Apply
        if: github.event_name == 'push'
        run: |
          cd HuggingFace/aws
          terraform apply -auto-approve

      - name: Terraform Destroy
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd HuggingFace/aws
          terraform destroy -auto-approve

  build_and_tag_docker:
    runs-on: ubuntu-latest
    needs: [terraform]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Debug Environment Variables
        run: |
          echo "AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID"
          echo "AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY"
          echo "AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION"

      - name: Build Docker image
        run: |
          cd Docker
          docker build -t ${{ secrets.ECR_REPOSITORY }} .

      - name: Tag Docker image
        run: |
          docker tag ${{ secrets.ECR_REPOSITORY }}:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest

  push_docker:
    runs-on: ubuntu-latest
    needs: [terraform, build_and_tag_docker]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Push Docker image to Amazon ECR
        run: |
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEFAULT_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest
